---
# file: storage_servers.yml
- hosts: storage_servers
  name: Initializing
  sudo: yes

  tasks:
    - name: Detect guest OS family
      group_by: key={{ ansible_os_family }}
      changed_when: False

    - name: Set hostname
      hostname: "name={{ inventory_hostname }}{% if ad_domain is defined %}.{{ ad_domain }}{% endif %}"

- hosts: RedHat
  name: Server Setup (RedHat)
  sudo: yes
  gather_facts: False

  tasks:
    - include: roles/common/tasks/setup-RedHat.yml

- hosts: storage_servers
  name: SMB Server Configuration
  sudo: yes

  tasks:
    - name: Creates directories
      file: path={{item}} state=directory
      with_items:
        - '/etc/samba'
        - '/etc/ctdb'

    - name: Copy Samba/CTDB config files
      template: src={{item.src}} dest={{item.dest}} owner=root group=root mode=0744
      with_items:
        - { src: 'files/smb.conf.j2', dest: '/etc/samba/smb.conf' }
        - { src: 'files/nodes.j2', dest: '/etc/ctdb/nodes' }
        - { src: 'files/ctdb', dest: '/etc/sysconfig/ctdb' }

- hosts: storage_servers
  name: Active Directory Configuration
  sudo: yes
  gather_facts: False

  tasks:
    - include: roles/samba/tasks/setup-AD.yml
      when: setup_ad
